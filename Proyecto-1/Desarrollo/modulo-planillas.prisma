enum estado_planilla {
  CONSTRUCCION
  APROBADA
  PROCESADA
  NOTIFICADA
}

enum naturaleza_movimiento {
  INGRESO
  DEDUCCION
}

enum modo_movimiento {
  FIJO
  PORCENTAJE
}

enum base_movimiento {
  BRUTO
  SALARIO_BASE
  HORAS
  PROCEDIMIENTOS
  PERSONALIZADA
}

enum aplica_a_movimiento {
  ADMINISTRATIVO
  MEDICO
  AMBOS
}

enum fuente_movimiento {
  AUTOMATICO
  MANUAL
}

enum accion_bitacora_planilla {
  CREAR
  GENERAR_DETALLES
  APROBAR
  APLICAR
  ENVIAR_COMPROBANTES
  REVERTIR
}

model ASC_tipo_planilla {
  tipo_planilla_id Int                 @id @default(autoincrement())
  nombre           String              @db.VarChar(80)
  aplica_a         aplica_a_movimiento
  descripcion      String?             @db.VarChar(255)
  activo           Boolean             @default(true)

  planillas ASC_planilla[]
}

model ASC_tipo_movimiento {
  tipo_movimiento_id Int                   @id @default(autoincrement())
  codigo             String                @unique @db.VarChar(40)
  nombre             String                @db.VarChar(120)
  naturaleza         naturaleza_movimiento
  aplica_a           aplica_a_movimiento
  modo               modo_movimiento
  base               base_movimiento
  porcentaje         Decimal?              @db.Decimal(8, 4)
  monto_fijo         Decimal?              @db.Decimal(18, 2)
  es_automatico      Boolean               @default(true)
  prioridad          Int                   @default(100)
  activo             Boolean               @default(true)
  regla_json         String?

  creado_en      DateTime @default(now())
  actualizado_en DateTime @updatedAt

  movimientos ASC_movimiento_planilla[]
}

model ASC_planilla {
  planilla_id      Int             @id @default(autoincrement())
  tipo_planilla_id Int
  periodo_anio     Int
  periodo_mes      Int
  estado           estado_planilla @default(CONSTRUCCION)

  fecha_generacion DateTime?
  fecha_aprobacion DateTime?
  fecha_procesada  DateTime?
  fecha_notificada DateTime?

  total_bruto       Decimal @default(0) @db.Decimal(18, 2)
  total_deducciones Decimal @default(0) @db.Decimal(18, 2)
  total_neto        Decimal @default(0) @db.Decimal(18, 2)

  creado_en      DateTime @default(now())
  actualizado_en DateTime @updatedAt

  detalles      ASC_detalle_planilla[]
  bitacoras     ASC_bitacora_planilla[]
  tipo_planilla ASC_tipo_planilla       @relation(fields: [tipo_planilla_id], references: [tipo_planilla_id])

  @@unique([tipo_planilla_id, periodo_anio, periodo_mes])
  @@index([tipo_planilla_id])
}

model ASC_detalle_planilla {
  detalle_planilla_id Int       @id @default(autoincrement())
  planilla_id         Int
  personal_id         Int
  tipo_personal       String    @db.VarChar(20)
  salario_base        Decimal   @default(0) @db.Decimal(18, 2)
  bruto               Decimal   @default(0) @db.Decimal(18, 2)
  deducciones         Decimal   @default(0) @db.Decimal(18, 2)
  neto                Decimal   @default(0) @db.Decimal(18, 2)
  cuenta_bancaria_id  Int?
  notificado_en       DateTime?
  email_enviado       Boolean   @default(false)
  comprobante_html    String?

  creado_en      DateTime @default(now())
  actualizado_en DateTime @updatedAt

  movimientos ASC_movimiento_planilla[]
  envios      ASC_envio_comprobante[]
  planilla    ASC_planilla              @relation(fields: [planilla_id], references: [planilla_id])

  @@unique([planilla_id, personal_id])
  @@index([planilla_id])
  @@index([personal_id])
  @@index([cuenta_bancaria_id])
}

model ASC_movimiento_planilla {
  movimiento_planilla_id Int               @id @default(autoincrement())
  detalle_planilla_id    Int
  tipo_movimiento_id     Int
  fuente                 fuente_movimiento @default(AUTOMATICO)
  monto                  Decimal           @db.Decimal(18, 2)
  observacion            String?           @db.VarChar(255)
  calculo_json           String?

  creado_en        DateTime              @default(now())
  tipo_movimiento  ASC_tipo_movimiento?  @relation(fields: [tipo_movimiento_id], references: [tipo_movimiento_id])
  detalle_planilla ASC_detalle_planilla? @relation(fields: [detalle_planilla_id], references: [detalle_planilla_id])

  @@index([detalle_planilla_id])
  @@index([tipo_movimiento_id])
}

model ASC_envio_comprobante {
  envio_comprobante_id Int                   @id @default(autoincrement())
  detalle_planilla_id  Int
  email                String                @db.VarChar(150)
  enviado_en           DateTime              @default(now())
  error                String?               @db.VarChar(255)
  detalle_planilla     ASC_detalle_planilla? @relation(fields: [detalle_planilla_id], references: [detalle_planilla_id])

  @@index([detalle_planilla_id])
}

model ASC_bitacora_planilla {
  bitacora_planilla_id Int                      @id @default(autoincrement())
  planilla_id          Int
  accion               accion_bitacora_planilla
  detalle              String?                  @db.VarChar(255)
  actor_id             Int?
  creado_en            DateTime                 @default(now())
  planilla             ASC_planilla?            @relation(fields: [planilla_id], references: [planilla_id])

  @@index([planilla_id])
  @@index([actor_id])
}

model ASC_turno_planilla {
  turno_planilla_id         Int       @id @default(autoincrement())
  detalle_planilla_id       Int
  escala_mensual_detalle_id Int
  horas                     Decimal   @db.Decimal(10, 2)
  monto_cobrado_centro      Decimal   @db.Decimal(18, 2)
  monto_pagado_medico       Decimal   @db.Decimal(18, 2)
  procesado                 Boolean   @default(false)
  procesado_en              DateTime?

  @@index([detalle_planilla_id])
  @@index([escala_mensual_detalle_id])
}

model ASC_procedimiento_planilla {
  procedimiento_planilla_id Int       @id @default(autoincrement())
  detalle_planilla_id       Int
  procedimiento_id          Int
  cantidad                  Int       @default(1)
  monto_cobrado             Decimal   @db.Decimal(18, 2)
  monto_pagado_medico       Decimal   @db.Decimal(18, 2)
  procesado                 Boolean   @default(false)
  procesado_en              DateTime?

  @@index([detalle_planilla_id])
  @@index([procedimiento_id])
}

model ASC_personal_tipo_planilla {
  personal_tipo_planilla_id Int      @id @default(autoincrement())
  personal_id               Int
  tipo_planilla_id          Int
  activo                    Boolean  @default(true)
  asignado_en               DateTime @default(now())

  @@unique([personal_id, tipo_planilla_id])
  @@index([tipo_planilla_id])
}
