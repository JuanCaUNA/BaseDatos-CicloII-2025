-- * MODULO DE PERSONAL *
-- * ------------------


-- ! NOTAS: ESTANDARES;
-- ACS NOMBRE DE LA EMPRESA
-- NOMBRES DE TABLAS: ACS_<NOMBRE>
--                    LIMITE DE LARGO: 30 CARACTERES
-- NOMBRES DE COLUMNAS:
--                      LIMITE DE LARGO: 30 CARACTERES


CREATE TABLE ACS_CLAVE (
   ACL_ID       NUMBER GENERATED BY DEFAULT AS IDENTITY,
   ACL_CLAVE    VARCHAR2(255) ENCRYPT NOT NULL
);

-- ! TABLA
CREATE TABLE ACS_PERMISO (
  APR_ID        NUMBER GENERATED BY DEFAULT AS IDENTITY,
  APR_PANTALLA  VARCHAR2(100),
  APR_LEER   NUMBER(1) DEFAULT 0,
  APR_CREAR  NUMBER(1) DEFAULT 0,
  APR_EDITAR NUMBER(1) DEFAULT 0,
  APR_ELIMINAR NUMBER(1) DEFAULT 0,
  APR_TIPO_USUARIO VARCHAR2(15),
   
   CONSTRAINT PK_APR PRIMARY KEY (APE_ID),

   CONSTRAINT UK_APR_PA_TU UNIQUE (APE_PANTALLA,APR_TIPO_USUARIO),

   CONSTRAINT CHK_APR_TIPO_USR CHECK (APE_TIPO_USUARIO IN ('MEDICO', 'ADMINISTRATIVO')),

   CONSTRAINT CHK_APR_LEER CHECK (APE_LEER IN (0, 1)),
   CONSTRAINT CHK_APR_CREAR CHECK (APE_CREAR IN (0, 1)),
   CONSTRAINT CHK_APR_EDITAR CHECK (APE_EDITAR IN (0, 1)),
   CONSTRAINT CHK_APR_ELIMINAR CHECK (APE_ELIMINAR IN (0, 1))
);

-- * COMENTARIOS DESCRIPTIVOS
COMMENT ON TABLE ACS_PERMISO IS 'PERMISOS DE ACCESO POR TIPO DE USUARIO';

-- ! TABLA
CREATE TABLE ACS_PERSONA (
   APE_ID             NUMBER GENERATED BY DEFAULT AS IDENTITY,
   APE_CEDULA         VARCHAR2(20) NOT NULL,
   APE_NOMBRE         VARCHAR2(200) NOT NULL,
   APE_P_APELLIDO      VARCHAR2(100) NOT NULL,
   APE_S_APELLIDO      VARCHAR2(100),
   APE_FECHA_NACIMIENTO DATE,
   
   APE_SEXO           VARCHAR2(10),
   APE_ESTADO_CIVIL   VARCHAR2(10),
   APE_TIPO_NACIONALIDAD VARCHAR2(10),
   APE_TIPO_USUARIO   VARCHAR2(15) NOT NULL,
   APE_ESTADO_REGISTRO VARCHAR2(10) DEFAULT 'PENDIENTE',
   
   APE_RESIDENCIA     VARCHAR2(255),
   APE_EMAIL          VARCHAR2(255),
   APE_TELEFONO       VARCHAR2(20),
   APE_DIRECCION_CASA VARCHAR2(255),
   APE_DIRECCION_TRABAJO VARCHAR2(255),

   APE_FECHA_CREACION DATE DEFAULT SYSDATE,
   APE_FECHA_ACTUALIZACION DATE DEFAULT SYSDATE,
   
   CONSTRAINT PK_ACS_PERSONA PRIMARY KEY (APE_ID),

   CONSTRAINT UK_APE_CEDULA UNIQUE (APE_CEDULA),
   CONSTRAINT UK_APE_EMAIL UNIQUE (APE_EMAIL),
   
   CONSTRAINT CHK_APE_SEXO CHECK (APE_SEXO IN ('MACULINO', 'FEMENINO')),
   CONSTRAINT CHK_APE_ESTADO_CIVIL CHECK (APE_ESTADO_CIVIL IN ('SOLTERO', 'CASADO', 'DIVORCIADO', 'VIUDO')),
   CONSTRAINT CHK_APE_TIPO_NACIONALIDAD CHECK (APE_TIPO_NACIONALIDAD IN ('NACIONAL', 'EXTRANJERO')),
   CONSTRAINT CHK_APE_TIPO_USUARIO CHECK (APE_TIPO_USUARIO IN ('MEDICO', 'ADMINISTRATIVO')),
   CONSTRAINT CHK_APE_ESTADO_REGISTRO CHECK (APE_ESTADO_REGISTRO IN ('PENDIENTE', 'APROBADO', 'RECHAZADO'))
);

-- * ÍNDICES
CREATE INDEX IDX_APE_NOMBRE_COMPLETO ON ACS_USUARIO (APE_NOMBRE, APE_P_APELLIDO, APE_S_APELLIDO);

-- * COMENTARIOS DESCRIPTIVOS
COMMENT ON TABLE ACS_PERSONA IS 'DATOS DE SOLICITANTES A SER USUARIOS, AL ACEPTAR SE DEBE DEFINIR EL TIPO DE USUARIO';
COMMENT ON COLUMN ACS_PERSONA.APE_RESIDENCIA IS 'LUGAR GENERAL DONDE VIVE';
COMMENT ON COLUMN ACS_PERSONA.APE_DIRECCION_CASA IS 'DIRECCIÓN ESPECÍFICA DE LA CASA';
COMMENT ON COLUMN ACS_PERSONA.APE_DIRECCION_TRABAJO IS 'DIRECCIÓN ESPECÍFICA DEL TRABAJO';
COMMENT ON COLUMN ACS_PERSONA.APE_ESTADO_REGISTRO IS 'AL CAMBIAR DE ESTADO, SE DEBE CREAR EL USUARIO O RECHAZAR LA SOLICITUD. LUEGO SE BORRA EL REGISTRO';

-- ! TABLA
CREATE TABLE ACS_USUARIO (
   AUS_ID             NUMBER GENERATED BY DEFAULT AS IDENTITY,
   AUS_ESTADO         VARCHAR2(10) DEFAULT 'ACTIVO',
   
   AUS_FECHA_CREACION DATE DEFAULT SYSDATE,

   APE_ID             NUMBER,
   
   CONSTRAINT PK_ACS_USUARIO PRIMARY KEY (AUS_ID),

   CONSTRAINT FK_USUARIO_PERSONA FOREIGN KEY (APE_ID) REFERENCES ACS_PERSONA (APE_ID),
   
   CONSTRAINT CHK_AUS_ESTADO CHECK (AUS_ESTADO IN ('ACTIVO', 'INACTIVO'))
);

-- * COMENTARIOS DESCRIPTIVOS
COMMENT ON TABLE ACS_USUARIO IS 'DATOS DE USUARIO';
COMMENT ON COLUMN ACS_USUARIO.AUS_RESIDENCIA IS 'LUGAR GENERAL DONDE VIVE';
COMMENT ON COLUMN ACS_USUARIO.AUS_DIRECCION_CASA IS 'DIRECCIÓN ESPECÍFICA DE LA CASA';
COMMENT ON COLUMN ACS_USUARIO.AUS_DIRECCION_TRABAJO IS 'DIRECCIÓN ESPECÍFICA DEL TRABAJO';
COMMENT ON COLUMN ACS_USUARIO.AUS_TIPO_USUARIO IS 'DEFINE EL PERFIL DEL USUARIO, SE DEBE CREAR EL PERFIL CORRESPONDIENTE CON EL MISNMO ID DE USUARIO, NO SE PUEDE CAMBIAR';

-- ! TABLA
CREATE TABLE ACS_BANCO (
   ABA_ID      NUMBER GENERATED BY DEFAULT AS IDENTITY,
   ABA_NOMBRE  VARCHAR2(100),
   ABA_TELEFONO VARCHAR2(20),
   
   CONSTRAINT PK_ACS_BANCO PRIMARY KEY (ABA_ID),
   CONSTRAINT UK_ACS_BANCO_NOMBRE UNIQUE (ABA_NOMBRE)
);

-- ! TABLA
CREATE TABLE ACS_CUENTA_BANCARIA (
   ACU_ID            NUMBER GENERATED BY DEFAULT AS IDENTITY,
   ACU_NUMERO_CUENTA VARCHAR2(50),
   ACU_TITULAR       VARCHAR2(200),

   ACU_TIPO_CUENTA   VARCHAR2(10),
   ACU_ES_PRINCIPAL  VARCHAR2(2) DEFAULT 'NO',

   AUS_ESTADO       VARCHAR2(10) DEFAULT 'ACTIVO',
   
   ABA_ID            NUMBER,
   AUS_ID            NUMBER,
   
   CONSTRAINT PK_ACS_CUENTA_BANCARIA PRIMARY KEY (ACU_ID),
   
   CONSTRAINT FK_CUENTA_BANCARIA_BANCO FOREIGN KEY (ABA_ID) REFERENCES ACS_BANCO (ABA_ID),
   CONSTRAINT FK_CUENTA_BANCARIA_USUARIO FOREIGN KEY (AUS_ID) REFERENCES ACS_USUARIO (AUS_ID),
   
   CONSTRAINT UK_ACU_NUMERO_CUENTA UNIQUE (ACU_NUMERO_CUENTA),
   
   CONSTRAINT CHK_ACU_TIPO_CUENTA CHECK (ACU_TIPO_CUENTA IN ('AHORROS', 'CORRIENTE')),
   CONSTRAINT CHK_ACU_ES_PRINCIPAL CHECK (ACU_ES_PRINCIPAL IN ('SI', 'NO')),
   CONSTRAINT CHK_ACU_ESTADO CHECK (AUS_ESTADO IN ('ACTIVO', 'INACTIVO'))
);

-- Restricción para solo una cuenta principal por usuario
CREATE UNIQUE INDEX UQ_ACU_PRINCIPAL_USUARIO ON ACS_CUENTA_BANCARIA (AUS_ID) WHERE ACU_ES_PRINCIPAL = 'SI';

-- ! TABLA
CREATE TABLE ACS_MEDICO (
   AME_ID      NUMBER,
   AME_ESTADO  VARCHAR2(10) DEFAULT 'ACTIVO',
   
   AUS_ID      NUMBER,

   CONSTRAINT PK_ACS_MEDICO PRIMARY KEY (AME_ID),

   CONSTRAINT FK_MEDICO_USUARIO FOREIGN KEY (AUS_ID) REFERENCES ACS_USUARIO (AUS_ID)

   CONSTRAINT UK_ACS_MEDICO_USUARIO UNIQUE (AUS_ID),
   
   CONSTRAINT CHK_ACS_MEDICO_ESTADO CHECK (AME_ESTADO IN ('ACTIVO', 'INACTIVO')),
);

-- * COMENTARIOS DESCRIPTIVOS
COMMENT ON COLUMN ACS_MEDICO.AME_ID IS 'EL ID DEL MÉDICO ES EL MISMO QUE EL ID DEL USUARIO ASOCIADO';

-- ! TABLA
CREATE TABLE ACS_ADMINISTRATIVO (
   AAD_ID      NUMBER,
   AAD_ESTADO  VARCHAR2(10) DEFAULT 'ACTIVO',
   
   AUS_ID      NUMBER,
   
   CONSTRAINT PK_ACS_ADMINISTRATIVO PRIMARY KEY (AAD_ID),

   CONSTRAINT FK_ADMINISTRATIVO_USUARIO FOREIGN KEY (AUS_ID) REFERENCES ACS_USUARIO (AUS_ID),

   CONSTRAINT UK_ACS_ADMINISTRATIVO_USR UNIQUE (AUS_ID),
   
   CONSTRAINT CHK_ACS_ADMINISTRATIVO_ESTADO CHECK (AAD_ESTADO IN ('ACTIVO', 'INACTIVO'))
);

-- * COMENTARIOS DESCRIPTIVOS
COMMENT ON COLUMN ACS_ADMINISTRATIVO.AAD_ID IS 'EL ID DEL ADMINISTRATIVO ES EL MISMO QUE EL ID DEL USUARIO ASOCIADO';

-- ! TABLA
CREATE TABLE ACS_DETALLE_DOCUMENTO (
   ADD_ID                NUMBER GENERATED BY DEFAULT AS IDENTITY,
   ADD_TIPO_USUARIO      VARCHAR2(20),
   ADD_DOCUMENTO_REQUERIDO VARCHAR2(4000),
   
   CONSTRAINT PK_ACS_DETALLE_DOCUMENTO PRIMARY KEY (ADD_ID),

   CONSTRAINT UK_ADD_TIPO_USUARIO UNIQUE (ADD_TIPO_USUARIO),

   CONSTRAINT CHK_ADD_TIPO_USUARIO CHECK (ADD_TIPO_USUARIO IN ('MEDICO', 'ADMINISTRATIVO'))
);

-- * COMENTARIOS DESCRIPTIVOS
COMMENT ON TABLE ACS_DETALLE_DOCUMENTO IS 'DOCUMENTOS REQUERIDOS POR TIPO DE USUARIO, SEPARADOS POR COMAS';

-- ! TABLA
CREATE TABLE ACS_DOCUMENTO_USUARIO (
   ADO_ID        NUMBER GENERATED BY DEFAULT AS IDENTITY,
   ADO_URL       VARCHAR2(1000),
   ADO_ESTADO    VARCHAR2(10) DEFAULT 'PENDIENTE',
   
   ADO_FECHA_CREACION DATE DEFAULT SYSDATE,
   ADO_FECHA_ACTUALIZACION DATE DEFAULT SYSDATE,
   
   AUS_ID        NUMBER,
   ADD_ID        NUMBER,

   CONSTRAINT PK_ACS_DOCUMENTO_USUARIO PRIMARY KEY (ADO_ID),
   
   CONSTRAINT FK_DOCUMENTO_USUARIO FOREIGN KEY (AUS_ID) REFERENCES ACS_USUARIO (AUS_ID),
   CONSTRAINT FK_DOCUMENTO_DETALLE FOREIGN KEY (ADD_ID) REFERENCES ACS_DETALLE_DOCUMENTO (ADD_ID),

   CONSTRAINT CHK_ADO_ESTADO CHECK (ADO_ESTADO IN ('PENDIENTE', 'APROBADO', 'RECHAZADO')),

   CONSTRAINT UK_ADO_URL_USUARIO UNIQUE (ADO_URL, AUS_ID)
);

-- * COMENTARIOS DESCRIPTIVOS
COMMENT ON TABLE ACS_DOCUMENTO_USUARIO IS 'DOCUMENTOS SUBIDOS POR LOS USUARIOS, RELACIONADOS CON SU';


-- * TRIGGERS
-- CREA EL USUARIO CUANDO EL ESTADO DEL PERSONA CAMBIA A 'APROBADO', ADEMAS ASIGNA EL PERFIL CORRESPONDIENTE
CREATE OR REPLACE TRIGGER TRG_AFTER_UPDATE_APE_ESR
AFTER UPDATE OF APE_ESTADO_REGISTRO ON ACS_PERSONA
FOR EACH ROW
DECLARE
   V_NEW_AUS_ID NUMBER;
BEGIN
   IF :NEW.APE_ESTADO_REGISTRO = 'APROBADO' THEN   
      INSERT INTO ACS_USUARIO (
         AUS_ID, APE_ID, AUS_FECHA_CREACION
      ) VALUES (
         :NEW.APE_ID, :NEW.APE_ID, SYSDATE
      )
      RETURNING AUS_ID INTO V_NEW_AUS_ID;

      IF :NEW.APE_TIPO_USUARIO = 'MEDICO' THEN
         INSERT INTO ACS_MEDICO (AME_ID, AME_ESTADO, AUS_ID)
         VALUES (V_NEW_AUS_ID, 'ACTIVO', V_NEW_AUS_ID);
      ELSIF :NEW.APE_TIPO_USUARIO = 'ADMINISTRATIVO' THEN
         INSERT INTO ACS_ADMINISTRATIVO (AAD_ID, AAD_ESTADO, AUS_ID)
         VALUES (V_NEW_AUS_ID, 'ACTIVO', V_NEW_AUS_ID);
      END IF;

   ELSIF :NEW.APE_ESTADO_REGISTRO = 'RECHAZADO' THEN
      DELETE FROM ACS_PERSONA WHERE APE_ID = :NEW.APE_ID;
   END IF;
END;
/

-- Trigger para actualizar APE_FECHA_ACTUALIZACION en ACS_PERSONA
CREATE OR REPLACE TRIGGER TRG_APE_UPDATE
BEFORE UPDATE ON ACS_PERSONA
FOR EACH ROW
BEGIN
   :NEW.APE_FECHA_ACTUALIZACION := SYSDATE;
END;
/

-- Trigger para actualizar ADO_FECHA_ACTUALIZACION en ACS_DOCUMENTO_USUARIO
CREATE OR REPLACE TRIGGER TRG_ACS_DOU_UPDATE
BEFORE UPDATE ON ACS_DOCUMENTO_USUARIO
FOR EACH ROW
BEGIN
   :NEW.ADO_FECHA_ACTUALIZACION := SYSDATE;
END;
/

-- * END MODULO DE PERSONAL *
-- * ------------------
