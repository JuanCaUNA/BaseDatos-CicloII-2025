version: "3.9"

services:
  oracle_primary:
    image: container-registry.oracle.com/database/enterprise:19.3.0.0
    platform: linux/amd64
    container_name: oracle_primary
    hostname: oracle-primary
    restart: unless-stopped
    environment:
      ORACLE_SID: ORCL
      ORACLE_PDB: ORCLPDB1
      ORACLE_PWD: admin123
      ORACLE_CHARACTERSET: AL32UTF8
      ORACLE_EDITION: enterprise
      TNS_ADMIN: /opt/oracle/network/admin
      ENABLE_ARCHIVELOG: "true"
      PRIMARY_DB_HOST: oracle-primary
      STANDBY_DB_HOST: oracle-standby
      STANDBY_DB_PORT: "1521"
    ports:
      - "1523:1521"
      - "8080:5500"
    volumes:
      - "${ORADATA_PRIMARY:-oradata_primary_volume}:/opt/oracle/oradata"
      - "${ORACLE_SHARED:-oracle_shared_volume}:/opt/oracle/shared"
      - ./oracle19c/config:/opt/oracle/config:ro
      - ./oracle19c/config/tnsnames_unified.ora:/opt/oracle/network/admin/tnsnames.ora
      - ./oracle19c/scripts/common:/opt/oracle/scripts/common:ro
      - "./oracle19c/scripts/automation:/opt/oracle/scripts/automation:ro"
      - "./oracle19c/scripts/primary:/opt/oracle/scripts/setup:ro"
      - "./oracle19c/scripts/startup:/opt/oracle/scripts/startup:ro"
    networks:
      - oracle_net
    healthcheck:
      test:
        - CMD-SHELL
        - bash -lc "source /opt/oracle/scripts/common/lib.sh >/dev/null 2>&1 && printf 'SELECT 1 FROM dual;\nEXIT;\n' | sqlplus -s / as sysdba | grep -q 1"
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

  oracle_standby:
    image: container-registry.oracle.com/database/enterprise:19.3.0.0
    platform: linux/amd64
    container_name: oracle_standby
    hostname: oracle-standby
    restart: unless-stopped
    environment:
      ORACLE_SID: STBY
      ORACLE_PDB: ORCLPDB1
      ORACLE_PWD: admin123
      ORACLE_CHARACTERSET: AL32UTF8
      ORACLE_EDITION: enterprise
      TNS_ADMIN: /opt/oracle/network/admin
      PRIMARY_DB_HOST: oracle-primary
      PRIMARY_DB_PORT: "1521"
      LOCAL_LISTENER_HOST: oracle-standby
    ports:
      - "1524:1521"
      - "8081:5500"
    depends_on:
      oracle_primary:
        condition: service_healthy
    volumes:
      - "${ORADATA_STANDBY:-oradata_standby_volume}:/opt/oracle/oradata"
      - "${ORACLE_SHARED:-oracle_shared_volume}:/opt/oracle/shared"
      - ./oracle19c/config:/opt/oracle/config:ro
      - ./oracle19c/config/tnsnames_unified.ora:/opt/oracle/network/admin/tnsnames.ora
      - ./oracle19c/scripts/common:/opt/oracle/scripts/common:ro
      - "./oracle19c/scripts/automation:/opt/oracle/scripts/automation:ro"
      - "./oracle19c/scripts/standby:/opt/oracle/scripts/setup:ro"
      - "./oracle19c/scripts/startup:/opt/oracle/scripts/startup:ro"
    networks:
      - oracle_net
    healthcheck:
      test:
        - CMD-SHELL
        - bash -lc "source /opt/oracle/scripts/common/lib.sh >/dev/null 2>&1 && printf 'SELECT 1 FROM dual;\nEXIT;\n' | sqlplus -s / as sysdba | grep -q 1"
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 240s

networks:
  oracle_net:
    driver: bridge

volumes:
  oradata_primary_volume:
    driver: local
  oradata_standby_volume:
    driver: local
  oracle_shared_volume:
    driver: local