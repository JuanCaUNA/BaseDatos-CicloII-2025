/*
Calculo de tamaño al convertir de texto a RAW
Tamaño en bytes = LONGITUD_EN_CARACTERES * 2
varchar2(100) -> 200 bytes -> puede almacenar hasta 100 caracteres
caracteres especiales pueden requerir más espacio nx4 100->400 bytes
*/

-- * TABLA *
CREATE TABLE ACS_CLAVE (
    ACL_ID       NUMBER GENERATED BY DEFAULT AS IDENTITY,
    ACL_NOMBRE_CLAVE VARCHAR2(50) UNIQUE NOT NULL,
    ACL_TIPO     VARCHAR2(20) NOT NULL, -- Correo SMTP, OTRO
    ACL_CLAVE    RAW(400) NOT NULL
);
/

-- * PRC guardar claves en ACS_CLAVE *
CREATE OR REPLACE PROCEDURE ACS_PRC_GUARDAR_CLAVE(
    P_NOMBRE_CLAVE IN ACS_CLAVE.ACL_NOMBRE_CLAVE%TYPE,
    P_TIPO IN ACS_CLAVE.ACL_TIPO%TYPE,
    P_CLAVE IN VARCHAR2
) AS
    V_CLAVE_ENCRIPTADA ACS_CLAVE.ACL_CLAVE%TYPE;
    V_KEY_RAW RAW(100);
BEGIN
    -- Obtener la clave y convertirla a RAW
    V_KEY_RAW := UTL_RAW.CAST_TO_RAW('MiClaveSuperSecreta');

    -- Encriptar la clave
    V_CLAVE_ENCRIPTADA := DBMS_CRYPTO.ENCRYPT(
        SRC => UTL_RAW.CAST_TO_RAW(P_CLAVE),
        TYP => DBMS_CRYPTO.AES256_CBC,
        KEY => V_KEY_RAW
    );

    -- Actualizar o Insertar
    MERGE INTO ACS_CLAVE t
    USING (SELECT P_NOMBRE_CLAVE AS ACL_NOMBRE_CLAVE, P_TIPO AS ACL_TIPO FROM DUAL) s
    ON (t.ACL_NOMBRE_CLAVE = s.ACL_NOMBRE_CLAVE AND t.ACL_TIPO = s.ACL_TIPO)
    WHEN MATCHED THEN
        UPDATE SET t.ACL_CLAVE = V_CLAVE_ENCRIPTADA, t.ACL_TIPO = P_TIPO
    WHEN NOT MATCHED THEN
        INSERT (ACL_NOMBRE_CLAVE, ACL_TIPO, ACL_CLAVE)
        VALUES (P_NOMBRE_CLAVE, P_TIPO, V_CLAVE_ENCRIPTADA);

EXCEPTION
    WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20001, 'Error al guardar la clave: ' || SQLERRM);
END ACS_PRC_GUARDAR_CLAVE;
/

-- * FUN obtener, desencriptar clave de ACS_CLAVE *
CREATE OR REPLACE FUNCTION ACS_FUN_OBTENER_CLAVE(
    P_NOMBRE_CLAVE IN ACS_CLAVE.ACL_NOMBRE_CLAVE%TYPE,
) RETURN VARCHAR2 IS
    V_CLAVE_ENCRIPTADA ACS_CLAVE.ACL_CLAVE%TYPE;
    V_CLAVE_DESENCRIPTADA VARCHAR2(100);
    V_KEY_RAW RAW(100);
BEGIN
    -- Obtener la clave y convertirla a RAW
    V_KEY_RAW := UTL_RAW.CAST_TO_RAW('MiClaveSuperSecreta');

    -- Recuperar la clave encriptada
    SELECT ACL_CLAVE INTO V_CLAVE_ENCRIPTADA
    FROM ACS_CLAVE
    WHERE ACL_NOMBRE_CLAVE = P_NOMBRE_CLAVE;

    -- Desencriptar la clave
    V_CLAVE_DESENCRIPTADA := UTL_RAW.CAST_TO_VARCHAR2(
        DBMS_CRYPTO.DECRYPT(
            SRC => V_CLAVE_ENCRIPTADA,
            TYP => DBMS_CRYPTO.AES256_CBC,
            KEY => V_KEY_RAW
        )
    );

    RETURN V_CLAVE_DESENCRIPTADA;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN NULL;
    WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20002, 'Error al obtener la clave: ' || SQLERRM);
END ACS_PRC_OBTENER_CLAVE;
/
